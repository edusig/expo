{"version":3,"file":"addStoriesAsync.js","sourceRoot":"","sources":["../../cli/addStoriesAsync.ts"],"names":[],"mappings":"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","sourcesContent":["import fse from 'fs-extra';\nimport path from 'path';\n\nimport { StoryOptions, StoryFile, StoryManifest } from '../types';\nimport { saveManifestAsync } from './saveManifestAsync';\nimport { getStoryManifest, generateId } from './shared';\nimport { writeStoriesAsync } from './writeStoriesAsync';\n\nexport async function addStoriesAsync(relPaths: string[], config: StoryOptions) {\n  const { watchRoot, projectRoot } = config;\n\n  // 1. read story manifest\n  const storyManifest: StoryManifest = getStoryManifest(projectRoot);\n\n  // 2. update story manifest with new files\n  await Promise.all(\n    relPaths.map(async relativePath => {\n      const fullPath = path.resolve(watchRoot, relativePath);\n      const id = generateId(fullPath);\n\n      const defaultTitle = relativePath\n        .split('/')\n        .pop()\n        ?.replace('.stories.tsx', '');\n\n      const story = await parseStoryConfigAsync({\n        id,\n        fullPath,\n        relativePath,\n        title: defaultTitle || '',\n        stories: [],\n      });\n\n      storyManifest.files[story.id] = story;\n    })\n  );\n\n  // 3. save updated manifest to disk\n  await saveManifestAsync(storyManifest, config);\n\n  // 4. write js file based on updated manifest\n  await writeStoriesAsync(config);\n}\n\nasync function parseStoryConfigAsync(storyFile: StoryFile) {\n  const { fullPath, id } = storyFile;\n  const file = fse.readFile(fullPath, { encoding: 'utf-8' });\n\n  const acorn = require('acorn-loose');\n\n  const parsed = acorn.parse(file, {\n    ecmaVersion: 2020,\n    sourceType: 'module',\n  });\n\n  const storyData = {\n    ...storyFile,\n  };\n\n  parsed.body.forEach(node => {\n    if (node.type === 'ExportNamedDeclaration') {\n      if (node.declaration !== null) {\n        const { type } = node.declaration;\n        if (type === 'VariableDeclaration') {\n          node.declaration.declarations.forEach(d => {\n            const name = d.id.name;\n            storyData.stories.push({\n              name,\n              id: `${id}_${name}`,\n            });\n          });\n        }\n\n        if (type === 'FunctionDeclaration') {\n          const name = node.declaration.id.name;\n          storyData.stories.push({\n            name,\n            id: `${id}_${name}`,\n          });\n        }\n      }\n\n      if (node.specifiers.length > 0) {\n        node.specifiers.forEach(specifier => {\n          const name = specifier.exported.name;\n          if (!storyData.stories.includes(name)) {\n            storyData.stories.push({\n              name,\n              id: `${id}_${name}`,\n            });\n          }\n        });\n      }\n    }\n  });\n\n  const defaultExport = parsed.body.find(node => node.type === 'ExportDefaultDeclaration');\n\n  if (defaultExport) {\n    defaultExport.declaration.properties.forEach(property => {\n      const key = property.key.name;\n      const value = property.value.value;\n\n      storyData[key] = value;\n    });\n  }\n\n  return storyData;\n}\n"]}